# 项目需求规格说明书：EVM 链通用私钥转账工具 (GUI 版) v1.3

## 1. 项目概况

- **目标**：开发一个基于 Python 的桌面端应用程序（GUI），用于在任意 EVM 兼容链上通过私钥进行自定义参数的交易发送。
- **核心价值**：解决用户在非主流 EVM 链或特定场景下（如抢跑、合约交互、数据上链）需要手动控制 Gas Price、Gas Limit 和 Input Data 的需求。
- **交付形式**：Windows 可执行文件 (`.exe`) 及完整 Python 源代码。

## 2. 技术栈要求

- **编程语言**：Python 3.x
- **核心库**：
  - `web3.py`：负责链上交互（连接节点、数据格式化、签名、广播）。
  - `threading` 或 `concurrent.futures`：**必须使用**，用于将所有网络 IO 操作放入后台线程，防止界面卡死。
- **UI 框架**：推荐 `tkinter` (原生轻量，无需额外依赖) 或 `PyQt`/`PySide` (界面更美观)，需确保打包后的 exe 体积适中。
- **打包工具**：`pyinstaller` (生成单文件 exe)。

## 3. 功能需求详情

### 3.1 网络配置与预检

- **RPC URL 输入**：允许用户输入自定义 HTTP RPC 链接 (支持 ETH, BSC, Polygon, L2 等所有 EVM 兼容链)。
- **连通性测试 (Connectivity Check)**：
    - **触发方式**：界面提供一个“测试连接”按钮，或当 RPC 输入框失去焦点时自动触发。
    - **逻辑**：后台尝试调用 `w3.eth.chain_id` 和 `w3.eth.block_number`。
    - **反馈**：
        - **成功**：在界面显示绿色提示 “✅ 已连接 (ChainID: 56, Height: 1234567)”。
        - **失败**：在界面显示红色提示 “❌ 连接失败，请检查 URL”。

### 3.2 交易参数配置 (界面交互)

界面需提供以下参数设置，并包含特定的预处理与辅助功能：

1.  **Private Key (私钥)**：
    - **安全展示**：输入框默认进行掩码处理（显示为 `******`）。
    - **辅助功能**：提供一个“👁️ 显示/隐藏”的切换按钮供用户核对。
2.  **To Address (接收地址)**：
    - **容错处理**：后台必须强制调用 `Web3.to_checksum_address()`，即使用户输入的是全小写地址或大小写混乱的地址，程序也能自动修正为标准格式，避免报错。
3.  **Value (金额)**：
    - **单位**：用户输入主网币数量（十进制，如 `0.1`）。
    - **逻辑**：程序需使用 `w3.to_wei(value, 'ether')` 将其转换为 Wei 参与计算。
4.  **Gas Price (Gwei)**：
    - **单位**：用户输入 Gwei（如 `20`）。
    - **逻辑**：程序需将其转换为 Wei。
    - **辅助功能**：提供一个 **“获取推荐 (Get)”** 按钮，点击后调用 `w3.eth.gas_price` 并自动填入当前网络建议的 Gas Price。
5.  **Gas Limit**：
    - **输入**：用户自定义整数（如 `21000`）。
    - **辅助功能**：提供一个 **“自动估算 (Estimate)”** 按钮。
    - **估算逻辑**：根据用户当前填写的 `To Address`、`Value` 和 `Input Data`，调用 `w3.eth.estimate_gas()`，并将返回结果自动填入输入框。
6.  **Input Data (十六进制)**：
    - **格式**：支持 `0x` 开头的十六进制字符串。
    - **逻辑**：程序需自动去除首尾空格；若用户留空，则默认为 `0x`（普通转账）。

### 3.3 隐藏/自动参数 (无需用户输入)

为了保证交易成功率，以下参数由程序后台自动获取，用户无需干预：

- **Chain ID**：根据 RPC 动态获取，防止重放攻击。
- **Nonce**：**必须**在发送前动态调用 `w3.eth.get_transaction_count(address)` 获取当前地址的最新交易计数。

### 3.4 核心交互流程 (异步处理与进度反馈)

1.  **启动**：用户打开软件，填入相关参数。
2.  **触发**：点击“发送交易”按钮。
3.  **UI 状态锁定与初始化**：
    - “发送交易”按钮变为“发送中...”并置灰（不可点击）。
    - **进度条组件** 显示并初始化为 0%。
    - **状态文本** 显示：“准备就绪...”。
4.  **后台线程执行 (Worker Thread)**：
    *程序需在每一步执行时，通过回调机制实时更新 UI 的进度条和状态文本：*
    - **Step 1: 本地校验与预检 (进度 10%)**
        - **状态文本**：“正在校验参数与余额...”
        - 校验私钥、地址、Input Data 格式。
        - **余额检查 (Pre-flight Check)**：查询账户余额，若 `余额 < (Value + GasLimit * GasPrice)`，则直接抛出异常，弹窗警告“余额不足以支付 Gas”，并终止流程。
    - **Step 2: 联网获取参数 (进度 30%)**
        - **状态文本**：“正在获取链上数据 (Nonce/ChainID)...”
        - 连接 RPC，获取最新的 `Nonce` 和 `Chain ID`。
    - **Step 3: 构建与签名 (进度 60%)**
        - **状态文本**：“正在构建并签名交易...”
        - 构建 Raw Transaction 对象，并使用私钥进行离线签名。
    - **Step 4: 广播交易 (进度 80%)**
        - **状态文本**：“正在广播交易至网络...”
        - 调用 `w3.eth.send_raw_transaction` 将签名后的数据发送至节点。
5.  **反馈机制 (进度 100%)**：
    - **成功**：
        - 进度条更新为 100%（建议显示绿色）。
        - 状态文本更新为：“✅ 发送成功”。
        - 弹窗或在界面文本域中显示返回的 **Transaction Hash**，方便用户复制。
        - 恢复“发送交易”按钮状态。
    - **失败**：
        - 进度条变红或重置。
        - 状态文本显示具体的错误原因（如 "RPC Error", "Reverted", "Timeout"）。
        - 弹窗显示详细错误堆栈，并恢复按钮状态以便重试。

## 4. 非功能性与体验需求

- **防假死 (Anti-Freezing)**：**严禁**在 UI 主线程进行任何网络 IO 操作（如连接节点、查询余额、发送交易）。必须使用多线程技术，确保在网络超时或节点响应慢时，软件窗口依然可以拖动、最小化，且不会显示“无响应”。
- **视觉反馈 (Visual Feedback)**：
    - **进度条**：界面底部或按钮上方需包含一个进度条控件。
    - **状态标签**：进度条旁需配备文本标签，实时告知用户当前程序正在干什么，缓解等待焦虑。
- **易用性与默认值**：
    - Gas Limit 默认值设为 `21000`。
    - Gas Price 默认留空或设为 `5`。
- **配置持久化**：
    - 程序关闭时，自动将当前的 **RPC URL** 和 **From Address**（注意：**绝不能保存私钥**）保存到本地 `config.json` 文件中。
    - 程序下次启动时，自动读取并填入这些配置，减少用户重复输入。

## 5. 交付清单

1.  **可执行程序**：`EVM_Transfer_Tool.exe` (Windows 64 位版本，无需安装 python 环境即可运行)。
2.  **源代码**：所有 `.py` 源码文件及 `requirements.txt` 依赖列表。
3.  **说明文档**：源码中需包含详细的中文注释，解释签名逻辑；附带一份简易的 `README.txt` 说明如何配置 RPC 和使用工具。
